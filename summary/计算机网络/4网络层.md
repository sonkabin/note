# 网络层

负责在不同网络之间基于IP地址尽力转发数据包，不负责丢失重传，也不负责传输数据的顺序

## 网络设备和OSI参考模型的关系

### 发送端

1. 应用层：准备要发送的数据
2. 传输层：将文件分段并编号
3. 网络层：添加目标IP地址和源IP地址
4. 数据链路层：使用自己的子网掩码判断自己在哪个网段，再用自己的子网掩码判断目标地址在哪个网段。**两种情况：**
   - 若是同一网段，使用ARP协议广播获得目标IP地址的MAC地址
   - 若不是同一网段，使用ARP协议广播获得路由器的MAC地址

![1552215511057](img/1552215511057.jpg)

## 网络层协议

### ARP协议

将IP地址通过广播（目标MAC地址是FF-FF-FF-FF-FF-FF），解析目标IP地址的MAC地址

#### ARP欺骗

当收到广播时，发送错误的MAC地址给广播的源

---

arp -s 192.168.0.1  00-cc-ss-ff-ee-ff	静态绑定MAC地址

arp -a

本地连接-->修复，可清除arp的缓存

### ICMP协议

作用：通常用于返回错误信息或是分析路由，依靠IP完成任务

ping：time查看延迟，ttl表示数据包的生命周期（每过一个路由器都减一，到0时灰飞烟灭，用来防止包在路由器之间循环）

ttl默认值：

- Linux：64
- Windows：128
- Unix：255

ping /？ 命令帮助

ping 8.8.8.8 -i 2：更改ttl数据包时间，能够跟踪数据包途径的路由器

### IGMP协议（多播）

点到点：每台计算机都能调整自己的进度，但是消耗大

广播：播一份，让每台计算机都接收

组播=多播：每个种类播一份到多播IP地址，要接收的计算机绑定多播IP地址

IGMP协议即周期性扫描本网段中计算机绑定的多播IP地址，向上一路请求多播或拒绝多播

### IP数据包

![1552285452821](img/1552285452821.jpg)

- 版本：标记为4or6

- 首部长度：标识首部总长，若没有可变部分，就不需要首部长度了（因为固定了）。可变长度使用很少

- 区分服务：设置该数据包的优先级，同时路由器也要设置成能识别此优先级的

- 总长度：表示该数据包的长度，由于MAC帧大小的限制，最大1500字节，最大发送1480个字节的实际数据（1500-首部的20字节）

- 标识：该数据片属于哪个数据包
- 标志：数据包是一个分片还是完整的数据包。占3位，目前前2位有意义。标志字段的最低位是MF(More Fragment )，等于1表示还有分片，等于0表示是最后一个分片。标志字段的中间一位是DF(Don't Fragment)，只有当DF=0时才允许分片
- 生存时间：每过一个路由器减1
- 协议号：数据让哪个进程处理，ICMP为1，IGMP为2，TCP为6，UDP为17，IPv6为41，OSPF为89

### IP协议

RIP和OSPF，能自动学习路由的都是IP协议

**静态路由**

- 需要管理员告诉路由器所有没有直连的网络下一跳给谁
- 适合于小规模网络
- 不能自动调整路由

**动态路由**

- RIP：周期性广播路由表，30s更新路由信息，最大跳数为15跳（16跳认为不可达） 。选择最短到达路径的方式
- OSPF：选择最大的带宽路径

